version: 2

unit_tests:
  - name: test_clean_phone_functionality
    model: stg_customers
    description: |
      Tests if the clean_phone macro removes special characters correctly.
      
      Test cases:
      - Brazilian phone format with parentheses and dash: (11) 99999-9999
      - International format with plus and spaces: +55 21 8888-8888
      - Dots as separators: 31.7777.7777
      
      Expected behavior: All special characters should be removed, keeping only numbers
    
    given:
      - input: ref('raw_customers')
        rows:
          - {id: 1, first_name: "Ana", last_name: "Silva", email: "ana@email.com", phone: "(11) 99999-9999", address: "Rua A", city: "SÃ£o Paulo", state: "SP", zip_code: "01000-000", created_at: "2024-01-01", updated_at: "2024-01-01"}
          - {id: 2, first_name: "Bruno", last_name: "Costa", email: "bruno@email.com", phone: "+55 21 8888-8888", address: "Rua B", city: "Rio de Janeiro", state: "RJ", zip_code: "20000-000", created_at: "2024-01-02", updated_at: "2024-01-02"}
          - {id: 3, first_name: "Carla", last_name: "Mendes", email: "carla@email.com", phone: "31.7777.7777", address: "Rua C", city: "Belo Horizonte", state: "MG", zip_code: "30000-000", created_at: "2024-01-03", updated_at: "2024-01-03"}
    
    expect:
      rows:
        - {customer_id: 1, phone: "11999999999", has_valid_phone: true}
        - {customer_id: 2, phone: "5521888888888", has_valid_phone: true}
        - {customer_id: 3, phone: "3177777777", has_valid_phone: true}
